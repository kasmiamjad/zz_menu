<!DOCTYPE html>


<html lang="ar"
      x-data="menuViewer({ businessId: 265, locationId: 297 })"
      x-init="init()" :dir="dir">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Z &amp; Z Restaurant - Al Khobar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak]{display:none!important}
        .no-scrollbar::-webkit-scrollbar{display:none}
        .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    </style>
</head>
<body class="min-h-screen bg-neutral-50 text-neutral-900">
<!-- Reusable SAR icon template -->
<template id="sar-icon">
    <svg viewBox="0 0 1124.14 1256.39" xmlns="http://www.w3.org/2000/svg">
        <path fill="currentColor"
              d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z" />
        <path fill="currentColor"
              d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z" />
    </svg>
</template>

<!-- Navbar -->
<header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b">
    <!-- Row 1: brand + locale -->
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
        <div class="min-w-0 flex-1">
            <div class="truncate font-bold tracking-tight text-lg">
                Z &amp; Z Restaurant
            </div>
        </div>

        <div class="hidden sm:flex items-center gap-2">
            <select class="rounded-xl border border-neutral-200 bg-white px-2 py-1 text-sm" x-model="localeCode"
                    @change="applyLocale()">
                <option value="auto">اللغة | Language</option>
                <option value="ar">العربية</option>
                <option value="en">English</option>
            </select>
        </div>
    </div>

    <!-- Row 2: search -->
    <div class="mx-auto max-w-6xl px-4 pb-3 sm:pb-0">
        <div class="relative w-full sm:max-w-md sm:ms-auto">
            <div class="pointer-events-none absolute inset-y-0 start-0 flex items-center ps-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 opacity-60"
                     fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.3-4.3" />
                </svg>
            </div>
            <input type="search"
                   :placeholder="dir==='rtl' ? 'ابحث عن صنف...' : 'Search menu...'"
                   class="w-full rounded-2xl border border-neutral-200 bg-neutral-50/60 focus:bg-white ps-11 py-2.5 outline-none focus:border-neutral-300 placeholder-neutral-400"
                   x-model="q" />
        </div>
    </div>

    <!-- Sticky categories/subcategories bar -->
    <div class="border-t border-neutral-100 bg-white/80">
        <div class="mx-auto max-w-6xl px-4 py-3">
            <!-- Categories row -->
            <div class="no-scrollbar -mx-1 flex items-center gap-2 overflow-x-auto px-1">
                <button
                        @click="selectCategory(null)"
                        class="shrink-0 rounded-full px-3.5 py-2 text-sm border"
                        :class="isAllActive() ? 'bg-neutral-900 text-white border-neutral-900'
                        : 'bg-white border-neutral-200 hover:bg-neutral-100'">
                    <span x-text="dir==='rtl' ? 'الكل' : 'All'"></span>
                </button>

                <template x-if="loadingCats">
                    <template x-for="i in 6" :key="i">
                        <div class="h-9 w-24 shrink-0 animate-pulse rounded-full bg-neutral-200"></div>
                    </template>
                </template>
                <template x-if="!loadingCats">
                    <template x-for="c in categories" :key="c.id">
                        <button
                                @click="selectCategory(c.id)"
                                class="shrink-0 rounded-full px-3.5 py-2 text-sm border"
                                :title="c.name"
                                :class="isCatActive(c.id) ? 'bg-neutral-900 text-white border-neutral-900'
                                : 'bg-white border-neutral-200 hover:bg-neutral-100'">
                            <span x-text="c.name"></span>
                        </button>
                    </template>
                </template>
            </div>

            <!-- Subcategories row -->
            <template x-if="subCategories.length">
                <div class="mt-3 no-scrollbar -mx-1 flex items-center gap-2 overflow-x-auto px-1">
                    <template x-for="sc in subCategories" :key="sc.id">
                        <button @click="toggleSubCategory(sc.id)"
                                class="shrink-0 rounded-full px-3.5 py-1.5 text-sm border"
                                :class="selectedSubId===sc.id ? 'bg-amber-500 text-white border-amber-500' : 'bg-white border-neutral-200 hover:bg-neutral-100'">
                            <span x-text="sc.name"></span>
                        </button>
                    </template>
                </div>
            </template>
        </div>
    </div>
</header>

<main class="mx-auto max-w-6xl px-4 py-5">
    <!-- Product grid / Loading / Empty -->
    <template x-if="loadingProducts">
        <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4">
            <template x-for="i in 8" :key="i">
                <div class="overflow-hidden rounded-2xl border border-neutral-200 bg-white">
                    <div class="aspect-[4/3] animate-pulse bg-neutral-200"></div>
                    <div class="space-y-2 p-3">
                        <div class="h-4 w-2/3 animate-pulse rounded bg-neutral-200"></div>
                        <div class="h-4 w-1/3 animate-pulse rounded bg-neutral-200"></div>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <template x-if="!loadingProducts && subFiltered.length===0">
        <div class="flex flex-col items-center justify-center py-16 text-center">
            <div class="mb-3 rounded-2xl bg-neutral-100 p-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 opacity-60" fill="none" stroke="currentColor"
                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3h18v18H3z" />
                    <path d="M9 9h6v6H9z" />
                </svg>
            </div>
            <div class="text-lg font-semibold" x-text="dir==='rtl' ? 'لا توجد عناصر' : 'No items found'"></div>
            <div class="mt-1 max-w-md text-neutral-500"
                 x-text="dir==='rtl' ? 'جرّب تغيير الفئة أو تعديل البحث.' : 'Try changing the category or adjusting your search.'"></div>
        </div>
    </template>

    <template x-if="!loadingProducts && subFiltered.length">
        <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4">
            <template x-for="(p, idx) in subFiltered" :key="p.sku + '-' + idx">
                <!-- Make card relative; add bottom padding only if action button exists -->
                <article
                        @click="openProductModal(p)"
                        class="relative group cursor-pointer overflow-hidden rounded-2xl border border-neutral-200 bg-white transition-shadow hover:shadow-md"
                        :class="hasAction(p) ? 'pb-12' : ''">
                    <div class="relative">
                        <img :src="p.image_url || p.image || ''" :alt="p.name || ''"
                             class="aspect-[4/3] w-full object-cover"
                             loading="lazy" decoding="async" fetchpriority="low" />
                        <template x-if="(p.modifiers?.length||0)>0">
                            <div class="absolute start-2 top-2 rounded-full bg-amber-500/95 px-2 py-0.5 text-[10px] font-semibold text-white shadow">
                                <span x-text="dir==='rtl' ? 'قابل للتخصيص' : 'Customizable'"></span></div>
                        </template>
                    </div>
                    <div class="p-3">
                        <div class="line-clamp-2 min-h-[2.5rem] font-semibold leading-snug" x-text="p.name"></div>
                        <div class="mt-1 text-sm text-neutral-500" x-text="p.category?.name || ''"></div>

                        <!-- Price with SAR icon (range-aware, smaller on mobile) -->
                        <div class="mt-2 flex items-center justify-between w-full">
                            <div class="text-xs sm:text-sm font-bold tracking-tight flex items-center gap-1.5">
                                <!-- Single price -->
                                <template x-if="priceRange(p).single">
                                    <div dir="ltr" class="flex items-center gap-1.5">
                                        <span x-html="sarIcon('4')"></span>
                                        <span x-text="numberFmt(priceRange(p).min)"></span>
                                    </div>
                                </template>
                                <!-- Range price -->
                                <template x-if="!priceRange(p).single">
                                    <div dir="ltr" class="flex items-center gap-1.5">
                                        <span x-html="sarIcon('4')"></span>
                                        <span x-text="numberFmt(priceRange(p).min)"></span>
                                        <span class="mx-1">-</span>
                                        <span x-html="sarIcon('4')"></span>
                                        <span x-text="numberFmt(priceRange(p).max)"></span>
                                    </div>
                                </template>
                                <span x-show="p.unit?.name" x-text="' / ' + p.unit.name"></span>
                            </div>
                        </div>
                    </div>

                    <!-- FULL-WIDTH bottom action button -->
                    <template x-if="hasAction(p)">
                        <button
                                @click.stop="openVariation(p)"
                                class="absolute inset-x-0 bottom-0 h-10 text-white text-xs sm:text-sm font-semibold"
                                :class="hasModifiersOnly(p) ? 'bg-green-600 hover:bg-green-700' : 'bg-orange-500 hover:bg-orange-600'">
                            <span
                                    x-text="dir==='rtl'
                                ? (hasModifiersOnly(p) ? 'عرض الاضافات' : 'عرض الخيارات')
                                : (hasModifiersOnly(p) ? 'Show Add-ons' : 'Choose options')">
                            </span>
                        </button>
                    </template>
                </article>
            </template>
        </div>
    </template>

    <!-- Infinite scroll sentinel -->
    <div x-ref="sentinel" class="h-10"></div>

    <!-- Variation / Modifiers Modal -->
    <div x-cloak x-show="showVarModal" @keydown.escape.window="closeVariation()"
         class="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/40" @click="closeVariation()"></div>
        <div class="relative w-full sm:max-w-lg bg-white rounded-t-2xl sm:rounded-2xl shadow-lg overflow-hidden">
            <div class="flex items-center justify-between border-b px-4 py-3">
                <h3 class="font-semibold" x-text="varProduct?.name || (dir==='rtl' ? 'الخيارات' : 'Options')"></h3>
                <button class="p-2 rounded hover:bg-neutral-100" @click="closeVariation()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18" />
                        <path d="m6 6 12 12" />
                    </svg>
                </button>
            </div>
            <div class="max-h-[70vh] overflow-y-auto p-4 space-y-6">
                <!-- Variations (filtered; no DUMMY) -->
                <template x-if="groupedVarOptions.length">
                    <div>
                        <div class="mb-3 text-sm font-semibold text-neutral-600"
                             x-text="dir==='rtl' ? 'الخيارات' : 'Variations'"></div>

                        <template x-for="(group, gi) in groupedVarOptions" :key="'var'+gi">
                            <div class="mb-3">
                                <div class="mb-2 text-sm font-semibold text-neutral-600" x-text="group.group"></div>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="opt in group.items" :key="opt.id">
                                        <button @click="selectVariation(opt)"
                                                :class="selectedVarId===opt.id ? 'bg-neutral-900 text-white border-neutral-900' : 'bg-white text-neutral-900 border-neutral-300 hover:bg-neutral-100'"
                                                class="text-sm border rounded-full px-3 py-1.5 inline-flex items-center gap-1.5">
                                            <span x-text="opt.name"></span>
                                            <span class="ms-2 text-xs opacity-70 inline-flex items-center gap-1.5"
                                                  dir="ltr">
                                                <span x-html="sarIcon('4')"></span>
                                                <span x-text="numberFmt(opt.price)"></span>
                                            </span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Modifiers (add-ons) -->
                <template x-if="modGroups.length">
                    <div>
                        <div class="mb-3 text-sm font-semibold text-neutral-600"
                             x-text="dir==='rtl' ? 'الإضافات' : 'Modifiers'"></div>
                        <template x-for="(grp, gi) in modGroups" :key="'modg'+gi">
                            <div class="mb-3">
                                <div class="mb-2 text-sm font-semibold text-neutral-600" x-text="grp.name"></div>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="(item, ii) in grp.items" :key="'mod'+gi+'-'+ii">
                                        <button type="button"
                                                @click="toggleModifier(gi, ii, item)"
                                                :class="isModSelected(gi, ii) ? 'bg-neutral-900 text-white border-neutral-900' : 'bg-white text-neutral-900 border-neutral-300 hover:bg-neutral-100'"
                                                class="text-sm border rounded-full px-3 py-1.5 inline-flex items-center gap-1.5">
                                            <span x-text="item.name"></span>
                                            <span class="ms-2 text-xs opacity-70 inline-flex items-center gap-1.5">
                                              <template x-if="item.price && item.price>0">
                                                <span class="inline-flex items-center gap-1.5" dir="ltr">
                                                  <span>+</span>
                                                  <span x-html="sarIcon('4')"></span>
                                                  <span x-text="numberFmt(item.price)"></span>
                                                </span>
                                              </template>
                                              <template x-if="!(item.price && item.price>0)">
                                                <span x-text="dir==='rtl' ? 'مجاني' : 'Free'"></span>
                                              </template>
                                            </span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            <div class="border-t p-4 flex items-center justify-end">
                <button class="rounded-lg px-4 py-2 border hover:bg-neutral-100" @click="closeVariation()"
                        x-text="dir==='rtl' ? 'إغلاق' : 'Close'"></button>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div x-cloak x-show="showProductModal"
         @keydown.escape.window="closeProductModal()"
         class="fixed inset-0 z-50 flex items-end sm:items-center justify-center">

        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/50" @click="closeProductModal()"></div>

        <!-- Modal -->
        <div class="relative w-full sm:max-w-lg bg-white rounded-t-2xl sm:rounded-2xl shadow-lg overflow-hidden">

            <!-- Image -->
            <div class="relative">
                <img
                        :src="activeProduct?.image_url || activeProduct?.image || ''"
                        class="w-full aspect-[4/3] object-cover"
                />
                <button
                        @click="closeProductModal()"
                        class="absolute top-3 end-3 bg-white/90 rounded-full p-2 shadow">
                    ✕
                </button>
            </div>

            <!-- Content -->
            <div class="p-4 space-y-3">
                <h3 class="text-lg font-bold" x-text="activeProduct?.name"></h3>

                <p class="text-sm text-neutral-600"
                   x-html="activeProduct?.product_description || (dir==='rtl' ? 'لا يوجد وصف' : 'No description available')">
                </p>

                <!-- Price -->
                <div class="flex items-center gap-2 font-bold">
                    <span x-html="sarIcon('5')"></span>
                    <span x-text="numberFmt(priceRange(activeProduct).min)"></span>
                </div>

                <!-- Category -->
                <div class="text-xs text-neutral-500">
                    <span x-text="activeProduct?.category?.name"></span>
                </div>
            </div>

            <!-- Actions -->
            <div class="border-t p-4 flex gap-2">
                <button
                        x-show="hasAction(activeProduct)"
                        @click="
        const p = activeProduct;
        closeProductModal();
        openVariation(p);
    "
                        class="flex-1 bg-orange-500 hover:bg-orange-600 text-white rounded-lg py-2 text-sm font-semibold">
                    <span x-text="dir==='rtl' ? 'عرض الخيارات' : 'Choose options'"></span>
                </button>

                <button
                        @click="closeProductModal()"
                        class="flex-1 border rounded-lg py-2 text-sm">
                    <span x-text="dir==='rtl' ? 'إغلاق' : 'Close'"></span>
                </button>
            </div>

        </div>
    </div>

</main>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('menuViewer', (opts = {}) => ({
            // State
            dir: document?.dir || 'ltr',
            localeCode: 'auto',
            currencyCode: 'SAR',
            apiOrigin: window.location.origin + '/api',
            businessId: opts.businessId ?? null,
            locationId: opts.locationId ?? null,
            base: '',
            loadingCats: true,
            loadingProducts: true,
            categories: [],
            selectedCatId: null,
            selectedSubId: null,
            products: [],
            page: 1,
            lastPage: 1,
            fetchingMore: false,
            // Variation / Modifiers modal
            showVarModal: false,
            varProduct: null,
            varOptions: [],
            selectedVarId: null,
            modGroups: [],       // [{ name, items:[{name, price, tax}] }]
            selectedMods: [],    // ['gi:ii']
            q: '',               // search term (server-side)
            // Product details modal
            showProductModal: false,
            activeProduct: null,

            // Init
            init() {
                if (!this.businessId || !this.locationId) {
                    const parts = window.location.pathname.split('/').filter(Boolean);
                    const i = Math.max(0, parts.findIndex(p => p === 'product-catalogue'));
                    const bid = Number(parts[i + 1]);
                    const lid = Number(parts[i + 2]);
                    if (Number.isFinite(bid)) this.businessId = bid;
                    if (Number.isFinite(lid)) this.locationId = lid;
                }
                this.base = `${this.apiOrigin}/product-catalogue/${this.businessId}/${this.locationId}`;
                this.fetchCategories();
                this.fetchProducts({ page: 1 });
                this.setupInfiniteScroll();
            },

            // Helpers
            isAllActive(){ return this.selectedCatId === null; },
            isCatActive(id){ return this.selectedCatId !== null && Number(this.selectedCatId) === Number(id); },
            sarIcon(size = '5', extra = 'inline text-gray-900') {
                const tpl = document.getElementById('sar-icon');
                if (!tpl) return '';
                const el = tpl.content.firstElementChild.cloneNode(true);
                el.classList.add(`!h-${size}`, `!w-${size}`);
                extra.split(' ').filter(Boolean).forEach(c => el.classList.add(c));
                return el.outerHTML;
            },
            applyLocale() {
                if (this.localeCode === 'auto') {
                    this.dir = this.isRTLText(document.documentElement.innerText) ? 'rtl' : 'ltr';
                } else {
                    this.dir = this.localeCode === 'ar' ? 'rtl' : 'ltr';
                }
                document.documentElement.setAttribute('dir', this.dir);
            },
            isRTLText(str) { return /[؀-ۿ]/.test(str || ''); },

            openProductModal(p){
                this.activeProduct = p;
                this.showProductModal = true;
            },
            closeProductModal(){
                this.showProductModal = false;
                this.activeProduct = null;
            },

            // Number-only formatter (no currency code)
            numberFmt(v) {
                if (v == null) return '-';
                const n = typeof v === 'string' ? parseFloat(v) : v;
                if (!isFinite(n)) return '-';
                try {
                    return new Intl.NumberFormat(this.localeCode === 'auto' ? undefined : this.localeCode, {
                        minimumFractionDigits: 2, maximumFractionDigits: 2,
                    }).format(n);
                } catch {
                    return (Math.round(n * 100) / 100).toFixed(2);
                }
            },

            // Price range calculator for a product
            priceRange(p) {
                const vars = (p?.product_variations || []).flatMap(pv => pv?.variations || []);
                const prices = vars.map(v => parseFloat(v?.price?.sell_price_inc_tax || v?.price?.default_sell_price)).filter(x => !isNaN(x));
                if (!prices.length) return { single: true, min: 0, max: 0 };
                const min = Math.min(...prices), max = Math.max(...prices);
                return { single: min === max, min, max };
            },

            get subCategories() {
                const cat = this.categories.find(c => c.id === this.selectedCatId);
                return cat?.sub_categories || [];
            },

            // SEARCH is server-side; no client filter by q
            get filtered() { return this.products; },
            get subFiltered() {
                if (!this.selectedSubId) return this.filtered;
                const sub = this.subCategories.find(sc => sc.id === this.selectedSubId);
                if (!sub) return this.filtered;
                const name = (sub?.name || '').toLowerCase();
                return this.filtered.filter(p =>
                    String(p?.category?.sub_category_id || '').includes(String(this.selectedSubId)) ||
                    (p?.category?.name || '').toLowerCase().includes(name),
                );
            },

            // Data fetching
            async fetchCategories() {
                this.loadingCats = true;
                try {
                    const r = await fetch(`${this.base}/categories`);
                    const j = await r.json();
                    this.categories = j?.data || [];
                    const sample = this.categories.slice(0, 3).map(c => c?.name || '').join(' ');
                    if (sample && this.isRTLText(sample)) this.dir = 'rtl';
                } catch (e) {
                    this.categories = [];
                } finally {
                    this.loadingCats = false;
                }
            },
            async fetchProducts({ catId = undefined, page = null, append = false } = {}) {
                // Figure out which category to use for THIS request
                const catParam = (catId !== undefined)
                    ? ((catId === null || catId === '') ? null : Number(catId))
                    : this.selectedCatId;

                if (catId !== undefined) {
                    this.selectedCatId = catParam;
                    this.selectedSubId = null;
                }

                if (page !== null && page !== undefined) this.page = Math.max(1, page);

                // Build URL from the local catParam (not from selectedCatId)
                let url = (catParam !== null && catParam !== undefined)
                    ? `${this.base}/products/${catParam}`
                    : `${this.base}/products`;

                const params = new URLSearchParams();
                if (this.q && this.q.trim()) params.set('name', this.q.trim());
                params.set('page', this.page);
                url += `?${params.toString()}`;

                this.loadingProducts = !append;
                try {
                    const r = await fetch(url);
                    const j = await r.json();
                    const arr = j?.data || [];
                    const pag = j?.pagination || {};
                    this.lastPage = pag?.last_page || 1;
                    this.page = pag?.current_page || this.page;
                    this.products = append ? [...this.products, ...arr] : arr;
                } catch (e) {
                    if (!append) { this.products = []; this.page = 1; this.lastPage = 1; }
                } finally {
                    this.loadingProducts = false;
                    this.fetchingMore = false;
                }
            },

            // Debounced input handler for search (wire to input if needed)
            onSearchInput() {
                this.page = 1;
                this.products = [];
                this.fetchProducts({ page: 1, catId: this.selectedCatId, append: false });
            },

            // Infinite scroll
            setupInfiniteScroll() {
                const el = this.$refs.sentinel;
                if (!('IntersectionObserver' in window) || !el) return;
                const io = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && !this.fetchingMore && this.page < this.lastPage) {
                            this.fetchingMore = true;
                            this.fetchProducts({ page: this.page + 1, append: true });
                        }
                    });
                }, { rootMargin: '200px' });
                io.observe(el);
            },

            selectCategory(id){
                this.selectedCatId = (id === null || id === undefined || id === '') ? null : Number(id);
                this.selectedSubId = null;
                this.page = 1;
                this.products = [];
                this.fetchProducts({ page: 1, catId: this.selectedCatId, append: false });
            },
            toggleSubCategory(id) {
                this.selectedSubId = this.selectedSubId === id ? null : id;
            },

            // ===== Variations & Modifiers =====
            // Helper: case-insensitive name check for "DUMMY"
            isDummyName(name){
                return (name || '').trim().toLowerCase() === 'dummy';
            },

            // Build a flat list of variation options, filtering out any group or option named "DUMMY"
            variationsOf(p){
                const out=[];
                (p?.product_variations || []).forEach(pv=>{
                    if (this.isDummyName(pv?.name)) return; // skip DUMMY group
                    (pv?.variations || []).forEach(v=>{
                        if (this.isDummyName(v?.name)) return; // skip DUMMY variation option
                        const price = v?.price?.sell_price_inc_tax ?? v?.price?.default_sell_price ?? null;
                        out.push({
                            group: pv?.name || (this.dir==='rtl' ? 'الخيارات' : 'Options'),
                            id: v?.id,
                            name: v?.name,
                            sku: v?.sku,
                            picture: v?.picture,
                            price: price ? parseFloat(price) : null
                        });
                    });
                });
                return out;
            },

            // True if there are any NON-DUMMY variation options
            hasMultipleVariations(p){
                return this.variationsOf(p).length > 0;
            },

            hasModifiers(p){
                return (p?.modifiers?.length || 0) > 0;
            },

            // True if there will be ANY bottom action (either variations or modifiers)
            hasAction(p){
                return this.hasMultipleVariations(p) || this.hasModifiers(p);
            },

            // True if ONLY modifiers are present (no valid variations)
            hasModifiersOnly(p){
                return this.hasModifiers(p) && !this.hasMultipleVariations(p);
            },

            modifiersOf(p){
                const raw = p?.modifiers || [];
                return raw.map(g => ({
                    name: g?.name || (this.dir==='rtl' ? 'إضافة' : 'Add-on'),
                    items: (g?.modifier_items || []).map(it => ({
                        name: it?.name || '',
                        price: Number(it?.price ?? 0) || 0,
                        tax: Number(it?.tax ?? 0) || 0
                    }))
                }));
            },

            isModSelected(gi, ii){ return this.selectedMods.includes(`${gi}:${ii}`); },
            toggleModifier(gi, ii){
                const id = `${gi}:${ii}`;
                const i = this.selectedMods.indexOf(id);
                if(i>=0) this.selectedMods.splice(i,1); else this.selectedMods.push(id);
            },

            openVariation(p){
                this.varProduct    = p;
                this.varOptions    = this.variationsOf(p);   // already DUMMY-filtered
                this.modGroups     = this.modifiersOf(p);
                this.selectedVarId = null;
                this.selectedMods  = [];
                this.showVarModal  = true;
            },
            closeVariation(){
                this.showVarModal = false;
                this.varProduct   = null;
                this.varOptions   = [];
                this.modGroups    = [];
                this.selectedVarId= null;
                this.selectedMods = [];
            },

            // Group variations for UI (already filtered of DUMMY)
            get groupedVarOptions(){
                const groups = {};
                this.varOptions.forEach(o => { (groups[o.group] ||= []).push(o); });
                return Object.entries(groups).map(([group,items]) => ({group,items}));
            },

            selectVariation(opt){ this.selectedVarId = opt.id; }, // keep modal open for modifiers
        }));
    });
</script>

</body>
</html>
